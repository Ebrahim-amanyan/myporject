<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ Ø³ÛŒÙ†Ù…Ø§ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ - ØªÙ…Ø§Ø´Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            color: #00d4ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
        }

        /* Connection Box */
        .connection-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }

        #status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .online { background: rgba(0, 255, 0, 0.15); color: #00ff88; }
        .offline { background: rgba(255, 0, 0, 0.15); color: #ff5555; }
        .connecting { background: rgba(255, 255, 0, 0.15); color: #ffff00; }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, #00d4ff, #0088ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            min-width: 180px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
        }

        input[type="text"] {
            padding: 12px 20px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 300px;
            font-size: 16px;
            text-align: center;
            margin: 10px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Main Content */
        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
        }

        /* Video Section */
        .video-section {
            flex: 3;
        }

        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        #videoPlayer {
            width: 100%;
            height: 400px;
            display: block;
        }

        .video-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        /* Chat Section */
        .chat-section {
            flex: 2;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(90deg, #0088ff, #00d4ff);
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
            min-height: 200px;
            background: rgba(0, 0, 0, 0.2);
        }

        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(0, 212, 255, 0.1);
            border-right: 3px solid #00d4ff;
        }

        .message.self {
            background: rgba(0, 255, 0, 0.1);
            border-right-color: #00ff88;
            text-align: left;
        }

        .message.system {
            background: rgba(255, 255, 0, 0.1);
            border-right-color: #ffaa00;
            text-align: center;
            font-size: 0.9em;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* File Upload */
        .upload-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .file-input {
            margin: 15px 0;
        }

        /* User Info */
        .user-info {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        #myPeerId {
            font-weight: bold;
            color: #00ff88;
            font-size: 1.2em;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 0.9em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00d4ff, #0088ff);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ Ø³ÛŒÙ†Ù…Ø§ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡</h1>
            <p class="subtitle">ØªÙ…Ø§Ø´Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† ÙÛŒÙ„Ù… + Ú†Øª ÙØ§Ø±Ø³ÛŒ | Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø±ÙˆØ±</p>
        </header>

        <div class="connection-box">
            <div id="status" class="offline">ğŸ”´ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†</div>
            
            <div class="buttons">
                <button onclick="createRoom()" id="createBtn">ğŸ  Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
                <button onclick="joinRoom()" id="joinBtn">ğŸ”— Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
                <button onclick="disconnect()" id="disconnectBtn" class="danger" disabled>âœ–ï¸ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„</button>
            </div>
            
            <div>
                <input type="text" id="roomIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø§ØªØ§Ù‚ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
            </div>
            
            <div class="user-info">
                <div>Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: <span id="myPeerId">---</span></div>
                <div>Ø§ØªØµØ§Ù„: <span id="connectionStatus">Ù‡ÛŒÚ†â€ŒÚ©Ø³</span></div>
            </div>
        </div>

        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <video id="videoPlayer" controls>
                        Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù¾Ø®Ø´ ÙˆÛŒØ¯Ø¦Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                    </video>
                </div>
                
                <div class="video-controls">
                    <input type="text" id="videoUrl" placeholder="Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… MP4 ÛŒØ§ YouTube">
                    <button onclick="loadVideo()">â–¶ï¸ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ</button>
                    <button onclick="shareVideo()">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒØ¯Ø¦Ùˆ</button>
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-header">ğŸ’¬ Ú†Øª ÙØ§Ø±Ø³ÛŒ</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        Ø¨Ù‡ Ø³ÛŒÙ†Ù…Ø§ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ø§ØªØ§Ù‚ÛŒ Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯.
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <h3>ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ ÙˆÛŒØ¯Ø¦Ùˆ</h3>
            <p>ÙØ§ÛŒÙ„ MP4 Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± 50MB)</p>
            <div class="file-input">
                <input type="file" id="fileInput" accept="video/mp4,video/webm" style="color: white;">
                <button onclick="uploadVideo()">Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ø§Ø´ØªØ±Ø§Ú©</button>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <footer>
            <p>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ | Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ØµÙˆØµÛŒ Ø¯Ùˆ Ù†ÙØ± | Ù„ÛŒÙ†Ú© Ø§ØªØ§Ù‚ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³Øª Ø®ÙˆØ¯ Ø¨ÙØ±Ø³ØªÛŒØ¯!</p>
            <p>ğŸ’¡ Ù†Ú©ØªÙ‡: Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø§ØªØµØ§Ù„ Û±Û°-Û²Û° Ø«Ø§Ù†ÛŒÙ‡ Ø²Ù…Ø§Ù† Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯.</p>
        </footer>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        let peer = null;
        let conn = null;
        let dataChannel = null;
        let currentRoom = null;
        let myPeerId = null;

        // Ø¹Ù†Ø§ØµØ± DOM
        const statusEl = document.getElementById('status');
        const myPeerIdEl = document.getElementById('myPeerId');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const roomIdInput = document.getElementById('roomIdInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoUrlInput = document.getElementById('videoUrl');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        // Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØªØµØ§Ù„
        const CONNECTION_STATES = {
            DISCONNECTED: 'disconnected',
            CONNECTING: 'connecting',
            CONNECTED: 'connected'
        };
        
        let connectionState = CONNECTION_STATES.DISCONNECTED;

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„ ====================

        // Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯
        function createRoom() {
            if (peer) return;
            
            updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚...', 'connecting');
            
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² PeerJS Ø¨Ø§ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                myPeerIdEl.textContent = id;
                currentRoom = id;
                roomIdInput.value = id;
                
                updateStatus('Ø§ØªØ§Ù‚ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯! Ù…Ù†ØªØ¸Ø± Ù¾ÛŒÙˆØ³ØªÙ† Ø¯ÙˆØ³Øª...', 'online');
                updateConnectionStatus('Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯ÙˆØ³Øª...');
                
                createBtn.disabled = true;
                joinBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª
                const inviteLink = `${window.location.href}?join=${id}`;
                addSystemMessage(`âœ… Ø§ØªØ§Ù‚ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ "${id}" Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯.`);
                addSystemMessage(`ğŸ“¨ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: ${inviteLink}`);
                addSystemMessage('Ù„ÛŒÙ†Ú© Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³Øª Ø®ÙˆØ¯ Ú©Ù¾ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.');
            });

            peer.on('connection', (connection) => {
                setupDataConnection(connection);
            });

            peer.on('error', (err) => {
                console.error('Ø®Ø·Ø§ÛŒ PeerJS:', err);
                
                // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬
                if (err.type === 'browser-incompatible') {
                    updateStatus('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Chrome ÛŒØ§ Firefox Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.', 'offline');
                } else if (err.type === 'disconnected') {
                    updateStatus('Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯.', 'offline');
                } else if (err.type === 'network') {
                    updateStatus('Ù…Ø´Ú©Ù„ Ø´Ø¨Ú©Ù‡. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.', 'offline');
                } else {
                    updateStatus(`Ø®Ø·Ø§: ${err.type}`, 'offline');
                }
                
                resetConnection();
            });

            peer.on('disconnected', () => {
                updateStatus('Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯.', 'offline');
                resetConnection();
            });
        }

        // Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø§ØªØ§Ù‚
        function joinRoom() {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø§ØªØ§Ù‚ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            if (peer) return;
            
            updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ØªØ§Ù‚...', 'connecting');
            
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                myPeerIdEl.textContent = id;
                currentRoom = roomId;
                
                // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ØªØ§Ù‚
                const connection = peer.connect(roomId, {
                    reliable: true,
                    serialization: 'json'
                });
                
                setupDataConnection(connection);
                
                createBtn.disabled = true;
                joinBtn.disabled = true;
                disconnectBtn.disabled = false;
            });

            peer.on('error', (err) => {
                console.error('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„:', err);
                updateStatus(`Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${err.message || err.type}`, 'offline');
                resetConnection();
            });
        }

        // ØªÙ†Ø¸ÛŒÙ… Ø§ØªØµØ§Ù„ Ø¯Ø§Ø¯Ù‡
        function setupDataConnection(connection) {
            conn = connection;
            dataChannel = connection;
            
            connection.on('open', () => {
                updateStatus('âœ… Ù…ØªØµÙ„ Ø¨Ù‡ Ø¯ÙˆØ³Øª!', 'online');
                updateConnectionStatus('Ù…ØªØµÙ„ Ø¨Ù‡ Ø¯ÙˆØ³Øª');
                addSystemMessage('ğŸ‰ Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø¯ÙˆØ³Øª Ø´Ù…Ø§ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯!');
                addSystemMessage('Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ¯Ø¦Ùˆ ØªÙ…Ø§Ø´Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ú©Ù†ÛŒØ¯.');
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ
                sendData({ type: 'requestSync' });
            });

            connection.on('data', (data) => {
                handleIncomingData(data);
            });

            connection.on('close', () => {
                updateStatus('ğŸ”´ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯', 'offline');
                updateConnectionStatus('Ù‚Ø·Ø¹ Ø´Ø¯Ù‡');
                addSystemMessage('Ø¯ÙˆØ³ØªØ§Ù† Ø´Ù…Ø§ Ø§Ø² Ø§ØªØ§Ù‚ Ø®Ø§Ø±Ø¬ Ø´Ø¯.');
                resetConnection();
            });

            connection.on('error', (err) => {
                console.error('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¯Ø§Ø¯Ù‡:', err);
                addSystemMessage('Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø±Ø® Ø¯Ø§Ø¯.');
            });
        }

        // Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„
        function disconnect() {
            if (dataChannel) {
                dataChannel.close();
            }
            if (peer) {
                peer.destroy();
            }
            resetConnection();
            updateStatus('ğŸ”´ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'offline');
            updateConnectionStatus('Ù‡ÛŒÚ†â€ŒÚ©Ø³');
            addSystemMessage('Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯.');
        }

        // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø§ØªØµØ§Ù„
        function resetConnection() {
            if (peer) {
                peer.destroy();
            }
            peer = null;
            conn = null;
            dataChannel = null;
            currentRoom = null;
            
            createBtn.disabled = false;
            joinBtn.disabled = false;
            disconnectBtn.disabled = true;
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯Ø¦Ùˆ ====================

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ø² Ù„ÛŒÙ†Ú©
        function loadVideo() {
            const url = videoUrlInput.value.trim();
            if (!url) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            videoPlayer.src = url;
            videoPlayer.load();
            
            addSystemMessage(`ÙˆÛŒØ¯Ø¦Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: ${url.substring(0, 50)}...`);
            
            // Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ø¯ÙˆØ³Øª
            if (dataChannel && dataChannel.open) {
                sendData({
                    type: 'videoChange',
                    url: url,
                    sender: myPeerId
                });
            }
        }

        // Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒØ¯Ø¦ÙˆÛŒ ÙØ¹Ù„ÛŒ
        function shareVideo() {
            if (!videoPlayer.src) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙˆÛŒØ¯Ø¦Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            if (dataChannel && dataChannel.open) {
                sendData({
                    type: 'videoChange',
                    url: videoPlayer.src,
                    sender: myPeerId,
                    currentTime: videoPlayer.currentTime,
                    isPlaying: !videoPlayer.paused
                });
                addSystemMessage('ÙˆÛŒØ¯Ø¦Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³Øª Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
            } else {
                alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÛŒÚ© Ø¯ÙˆØ³Øª Ù…ØªØµÙ„ Ø´ÙˆÛŒØ¯!');
            }
        }

        // Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ ÙˆÛŒØ¯Ø¦Ùˆ
        function uploadVideo() {
            const file = fileInput.files[0];
            if (!file) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                alert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² ÛµÛ° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯!');
                return;
            }
            
            if (!file.type.startsWith('video/')) {
                alert('Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· ÙØ§ÛŒÙ„ ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            uploadStatus.innerHTML = '<span style="color:#00ff88">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...</span>';
            
            // Ø§ÛŒØ¬Ø§Ø¯ URL Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„
            const videoUrl = URL.createObjectURL(file);
            videoPlayer.src = videoUrl;
            videoPlayer.load();
            
            uploadStatus.innerHTML = `<span style="color:#00ff88">âœ… Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚: ${file.name} (${Math.round(file.size/1024/1024)}MB)</span>`;
            addSystemMessage(`ÙØ§ÛŒÙ„ "${file.name}" Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯.`);
            
            // Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ø¯ÙˆØ³Øª
            if (dataChannel && dataChannel.open) {
                // Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ØŒ ÙÙ‚Ø· Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                sendData({
                    type: 'videoInfo',
                    fileName: file.name,
                    fileSize: file.size,
                    message: `ÙØ§ÛŒÙ„ "${file.name}" Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ø§Ù† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.`
                });
            }
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ú†Øª ====================

        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            if (!dataChannel || !dataChannel.open) {
                alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÛŒÚ© Ø¯ÙˆØ³Øª Ù…ØªØµÙ„ Ø´ÙˆÛŒØ¯!');
                return;
            }
            
            // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
            sendData({
                type: 'chat',
                text: text,
                sender: myPeerId,
                time: new Date().toLocaleTimeString('fa-IR')
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ù…Ø§Ù†
            addMessage(text, true);
            messageInput.value = '';
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒØ¯ Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ====================

        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡
        function sendData(data) {
            if (dataChannel && dataChannel.open) {
                dataChannel.send(data);
            } else {
                console.warn('Ú©Ø§Ù†Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø² Ù†ÛŒØ³Øª.');
            }
        }

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ
        function handleIncomingData(data) {
            switch (data.type) {
                case 'chat':
                    addMessage(data.text, false, data.sender);
                    break;
                    
                case 'videoChange':
                    if (data.url) {
                        videoPlayer.src = data.url;
                        videoPlayer.load();
                        
                        if (data.currentTime !== undefined) {
                            videoPlayer.currentTime = data.currentTime;
                        }
                        
                        if (data.isPlaying !== undefined) {
                            if (data.isPlaying) {
                                videoPlayer.play().catch(e => console.log('Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ù¾Ù„ÛŒ Ù†Ø´Ø¯'));
                            } else {
                                videoPlayer.pause();
                            }
                        }
                        
                        addSystemMessage(`Ø¯ÙˆØ³ØªØ§Ù† ÙˆÛŒØ¯Ø¦Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯: ${data.url.substring(0, 50)}...`);
                    }
                    break;
                    
                case 'videoControl':
                    if (data.action === 'play') {
                        videoPlayer.play().catch(e => console.log('Ù¾Ù„ÛŒ Ù†Ø´Ø¯'));
                    } else if (data.action === 'pause') {
                        videoPlayer.pause();
                    } else if (data.action === 'seek') {
                        videoPlayer.currentTime = data.time;
                    }
                    break;
                    
                case 'videoInfo':
                    addSystemMessage(`ğŸ“ ${data.message}`);
                    break;
                    
                case 'requestSync':
                    // Ø§Ø±Ø³Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ
                    if (videoPlayer.src) {
                        sendData({
                            type: 'videoSync',
                            url: videoPlayer.src,
                            currentTime: videoPlayer.currentTime,
                            isPlaying: !videoPlayer.paused
                        });
                    }
                    break;
                    
                case 'videoSync':
                    if (data.url) {
                        videoPlayer.src = data.url;
                        videoPlayer.load();
                        
                        if (data.currentTime !== undefined) {
                            setTimeout(() => {
                                videoPlayer.currentTime = data.currentTime;
                            }, 500);
                        }
                        
                        if (data.isPlaying) {
                            setTimeout(() => {
                                videoPlayer.play().catch(e => console.log('Ù¾Ù„ÛŒ Ù†Ø´Ø¯'));
                            }, 1000);
                        }
                        
                        addSystemMessage('ÙˆÛŒØ¯Ø¦Ùˆ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯.');
                    }
                    break;
            }
        }

        // ==================== Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ ====================

        // Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ
        videoPlayer.addEventListener('play', () => {
            sendData({
                type: 'videoControl',
                action: 'play',
                time: videoPlayer.currentTime
            });
        });

        videoPlayer.addEventListener('pause', () => {
            sendData({
                type: 'videoControl',
                action: 'pause',
                time: videoPlayer.currentTime
            });
        });

        videoPlayer.addEventListener('seeked', () => {
            sendData({
                type: 'videoControl',
                action: 'seek',
                time: videoPlayer.currentTime
            });
        });

        // ==================== Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ ====================

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
        function updateStatus(text, className) {
            statusEl.textContent = text;
            statusEl.className = className;
            
            if (className === 'online') {
                statusEl.innerHTML = 'ğŸŸ¢ ' + text;
            } else if (className === 'offline') {
                statusEl.innerHTML = 'ğŸ”´ ' + text;
            } else if (className === 'connecting') {
                statusEl.innerHTML = 'ğŸŸ¡ ' + text;
            }
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„
        function updateConnectionStatus(text) {
            connectionStatusEl.textContent = text;
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª
        function addMessage(text, isSelf = false, sender = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSelf ? 'self' : ''}`;
            
            const time = new Date().toLocaleTimeString('fa-IR');
            const senderName = isSelf ? 'Ø´Ù…Ø§' : (sender || 'Ø¯ÙˆØ³ØªØ§Ù†');
            
            messageDiv.innerHTML = `
                <div><strong>${senderName}:</strong> ${text}</div>
                <div style="font-size:0.8em; color:#aaa; text-align:left;">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            
            const time = new Date().toLocaleTimeString('fa-IR');
            
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div style="font-size:0.8em; color:#aaa;">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================

        // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ URL
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinId = urlParams.get('join');
            
            if (joinId) {
                roomIdInput.value = joinId;
                addSystemMessage(`ğŸ“¨ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙˆØ³ØªÙ† Ø¯Ú©Ù…Ù‡ "Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø§ØªØ§Ù‚" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.`);
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        function initialize() {
            updateStatus('Ø¢Ù…Ø§Ø¯Ù‡ Ø§ØªØµØ§Ù„...', 'offline');
            updateConnectionStatus('Ù‡ÛŒÚ†â€ŒÚ©Ø³');
            checkUrlParams();
            
            addSystemMessage('ğŸ¬ Ø¨Ù‡ Ø³ÛŒÙ†Ù…Ø§ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!');
            addSystemMessage('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ø§ØªØ§Ù‚ÛŒ Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯.');
            
            // ØªØ³Øª WebRTC
            if (!navigator.mediaDevices || !window.RTCPeerConnection) {
                updateStatus('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² WebRTC Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Chrome ÛŒØ§ Firefox Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.', 'offline');
            }
        }

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        window.onload = initialize;
    </script>
</body>
</html>
